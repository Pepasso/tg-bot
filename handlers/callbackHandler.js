// handlers/callbackHandler.js

const {
  sendMainMenu
} = require('../utils/ui');
const {
  showCategoryKeyboard,
  showServiceRegionKeyboard,
  showLawyersPage,
  showSellType,
  showProductsType,
  showPartsFresh,
  showBrandsPage,
  showServicesPage,
  showHowSell,
  showSellerInfo,
} = require('../utils/menus');
const {
  findModel,
  findService,
  findSellCars,
  findLawyer,
  findProductByType,
} = require('../services/searchService');
const {
  getSellerChatId,
  sendMessageToSeller,
  getAndreyChatId
} = require('../services/senderService');
const fs = require('fs');

function registerCallbackHandler(bot, state) {
  bot.on('callback_query', async (query) => {
    const chatId = query.message.chat.id;
    const data = query.data;
    const [action, ...params] = data.split('_');

    // Initialize state if it doesn't exist
    if (!state[chatId]) {
      state[chatId] = {};
    }

    try {
      await bot.deleteMessage(chatId, query.message.message_id);
    } catch (error) {
      // ignore
    }

    switch (action) {
      case 'find':
        state[chatId].currentPage = 0;
        showCategoryKeyboard(bot, chatId);
        break;
      case 'page':
        const page = parseInt(params[0]);
        state[chatId].currentPage = page;
        showBrandsPage(bot, chatId, page, state[chatId]);
        break;
      case 'servicepage':
        const servicePage = parseInt(params[0]);
        state[chatId].currentServicePage = servicePage;
        showServicesPage(bot, chatId, servicePage, state[chatId]);
        break;
      case 'lawyerpage':
        const lawyerPage = parseInt(params[0]);
        state[chatId].currentLawyersPage = lawyerPage;
        showLawyersPage(bot, chatId, lawyerPage, state[chatId]);
        break;
      case 'category':
        state[chatId].selectedCarCategory = parseInt(params[0]);
        showPartsFresh(bot, chatId);
        break;
      case 'fresh':
        state[chatId].selectedFresh = parseInt(params[0]);
        state[chatId].currentPage = 0;
        showBrandsPage(bot, chatId, 0, state[chatId]);
        break;
      case 'brand':
        const brand = params[0];
        const paidResults = findModel(brand, state[chatId].selectedCarCategory, state[chatId].selectedFresh, true);
        const otherResults = findModel(brand, state[chatId].selectedCarCategory, state[chatId].selectedFresh, false);

        if (paidResults && paidResults.length > 0) {
          for (const part of paidResults) {
            const phones = part.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            const clientMessageText = `
              üîß ${part.name}
              üìç –ê–¥—Ä–µ—Å: ${part.address}
              üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}

              ‚ÑπÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —á–∞—Ç, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
            `;

            if (part.chatUsername && part.chatUsername.trim() !== '') {
              const sellerTgId = parseInt(getSellerChatId(part.chatUsername)[0].tgId);
              if (sellerTgId) {
                const sellerMessage = `
                  –ú–∞—Ä–∫–∞: ${brand}
                  –ö–∞—á–µ—Å—Ç–≤–æ: ${state[chatId].selectedFresh}
                  –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${state[chatId].selectedCarCategory}
                  –ö–ª–∏–µ–Ω—Ç: ${query.message.from.first_name} (${query.message.from.id})
                `;
                const isSent = await sendMessageToSeller(bot, sellerTgId, sellerMessage);
                if (isSent) {
                  const chatUrl = `tg://resolve?domain=${encodeURIComponent(part.chatUsername)}`;
                  const chatKeyboard = {
                    inline_keyboard: [
                      [{
                        text: "–ù–∞—á–∞—Ç—å —á–∞—Ç",
                        url: chatUrl
                      }],
                      [{
                        text: "–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –º–∞—Ä–∫–∏",
                        callback_data: "find_command"
                      }],
                      [{
                        text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                        callback_data: "main_menu"
                      }]
                    ]
                  };
                  if (part.image && part.image.startsWith('./')) {
                    bot.sendPhoto(chatId, fs.createReadStream(part.image), {
                      caption: clientMessageText,
                      parse_mode: 'HTML',
                      reply_markup: chatKeyboard
                    });
                  } else {
                    bot.sendMessage(chatId, clientMessageText, {
                      parse_mode: 'HTML',
                      reply_markup: chatKeyboard
                    });
                  }
                } else {
                  bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–≤—Ü—É. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏–ª–∏ –Ω–µ –Ω–∞—á–∞–ª —Å –Ω–∏–º –¥–∏–∞–ª–æ–≥.');
                }
              } else {
                const chatKeyboard = {
                  inline_keyboard: [
                    [{
                      text: "–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –º–∞—Ä–∫–∏",
                      callback_data: "find_command"
                    }],
                    [{
                      text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                      callback_data: "main_menu"
                    }]
                  ]
                };
                bot.sendMessage(chatId, '‚ùå –ß–∞—Ç —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.', {
                  reply_markup: chatKeyboard
                });
              }
            } else {
              const chatKeyboard = {
                inline_keyboard: [
                  [{
                    text: "–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –º–∞—Ä–∫–∏",
                    callback_data: "find_command"
                  }],
                  [{
                    text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                    callback_data: "main_menu"
                  }]
                ]
              };
              bot.sendMessage(chatId, '–ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.', {
                reply_markup: chatKeyboard
              });
            }
          }
        }

        if (otherResults && otherResults.length > 0) {
          const otherPartsList = otherResults.map(part => {
            const phones = part.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            return `üîß ${part.name}\nüìç –ê–¥—Ä–µ—Å: ${part.address}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}`;
          }).join('\n\n');
          bot.sendMessage(chatId, `‚úÖ –ù–∞–π–¥–µ–Ω—ã –∑–∞–ø—á–∞—Å—Ç–∏ –¥–ª—è ${brand}:\n\n${otherPartsList}`, {
            parse_mode: 'HTML',
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –º–∞—Ä–∫–∏",
                  callback_data: "find_command"
                }],
                [{
                  text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                  callback_data: "main_menu"
                }]
              ]
            }
          });
        } else if (!paidResults || (paidResults.length === 0 && !otherResults)) {
          bot.sendMessage(chatId, `üòû –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É "${brand}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`, {
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                  callback_data: "find_command"
                }]
              ]
            }
          });
        }
        break;
      case 'serviceregion':
        state[chatId].serviceRegion = parseInt(params[0]);
        state[chatId].currentServicePage = 0;
        showServicesPage(bot, chatId, 0, state[chatId]);
        break;
      case 'service':
        const serviceKey = params.join('_');
        const originalServiceKey = serviceKey.replace(/_/g, ' ');
        const paidServices = findService(serviceKey, state[chatId].serviceTypeOrg, state[chatId].serviceRegion, true);
        const otherServices = findService(serviceKey, state[chatId].serviceTypeOrg, state[chatId].serviceRegion, false);

        if (paidServices && paidServices.length > 0) {
          for (const service of paidServices) {
            const phones = service.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            const clientMessage = `
              üîß ${service.name}
              üìç –ê–¥—Ä–µ—Å: ${service.address}
              üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}

              ${service.additional || ''}
            `.replace(/^[ \t]+/gm, '').trim();

            if (service.chatUsername) {
              const sellerTgId = getSellerChatId(service.chatUsername)[0].tgId;
              if (sellerTgId) {
                const sellerMessage = `
                  –£—Å–ª—É–≥–∞: ${originalServiceKey}
                  –ö–ª–∏–µ–Ω—Ç: ${query.message.from.first_name} (${query.message.from.id})
                `;
                const isSent = await sendMessageToSeller(bot, sellerTgId, sellerMessage);
                if (isSent) {
                  const chatUrl = `tg://resolve?domain=${encodeURIComponent(service.chatUsername)}`;
                  const keyboard = {
                    inline_keyboard: [
                      [{
                        text: "–ù–∞—á–∞—Ç—å —á–∞—Ç",
                        url: chatUrl
                      }],
                      [{
                        text: "–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–∏—Å–∞–º",
                        callback_data: "command_service"
                      }],
                      [{
                        text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                        callback_data: "main_menu"
                      }]
                    ]
                  };
                  if (service.image) {
                    bot.sendPhoto(chatId, fs.createReadStream(service.image), {
                      caption: clientMessage,
                      parse_mode: 'HTML',
                      reply_markup: keyboard
                    });
                  } else {
                    bot.sendMessage(chatId, clientMessage, {
                      parse_mode: 'HTML',
                      reply_markup: keyboard
                    });
                  }
                } else {
                  bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
              }
            } else {
              const keyboard = {
                inline_keyboard: [
                  [{
                    text: "–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–∏—Å–∞–º",
                    callback_data: "command_service"
                  }],
                  [{
                    text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                    callback_data: "main_menu"
                  }]
                ]
              };
              if (service.image) {
                bot.sendPhoto(chatId, fs.createReadStream(service.image), {
                  caption: clientMessage,
                  parse_mode: 'HTML',
                  reply_markup: keyboard
                });
              } else {
                bot.sendMessage(chatId, clientMessage, {
                  parse_mode: 'HTML',
                  reply_markup: keyboard
                });
              }
            }
          }
        }

        if (otherServices && otherServices.length > 0) {
          const otherServicesList = otherServices.map(service => {
            const phones = service.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            return `üîß ${service.name}\nüìç –ê–¥—Ä–µ—Å: ${service.address}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}`;
          }).join('\n\n');
          bot.sendMessage(chatId, `‚úÖ –ù–∞–π–¥–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è ${originalServiceKey}:\n\n${otherServicesList}`, {
            parse_mode: 'HTML',
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ù–∞–∑–∞–¥ –∫ —Å–µ—Ä–≤–∏—Å–∞–º",
                  callback_data: "command_service"
                }],
                [{
                  text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                  callback_data: "main_menu"
                }]
              ]
            }
          });
        } else if (!paidServices || (paidServices.length === 0 && !otherServices)) {
          bot.sendMessage(chatId, `üòû –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è "${originalServiceKey}"`, {
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                  callback_data: "command_service"
                }]
              ]
            }
          });
        }
        break;
      case 'lawyer':
        const lawyerKey = params.join('_');
        const originalLawyerKey = lawyerKey.replace(/_/g, ' ');
        const paidLawyers = findLawyer(lawyerKey, true);
        const otherLawyers = findLawyer(lawyerKey, false);

        if (paidLawyers && paidLawyers.length > 0) {
          for (const lawyer of paidLawyers) {
            const phones = lawyer.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            const clientMessage = `
              üîß ${lawyer.name}
              üìç –ê–¥—Ä–µ—Å: ${lawyer.address}
              üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}

              ${lawyer.additional}
            `.replace(/^[ \t]+/gm, '').trim();

            if (lawyer.chatUsername) {
              const sellerTgId = getSellerChatId(lawyer.chatUsername)[0].tgId;
              if (sellerTgId) {
                const sellerMessage = `
                  –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å: ${originalLawyerKey}
                  –ö–ª–∏–µ–Ω—Ç: ${query.message.from.first_name} (${query.message.from.id})
                `;
                const isSent = await sendMessageToSeller(bot, sellerTgId, sellerMessage);
                if (isSent) {
                  const chatUrl = `tg://resolve?domain=${encodeURIComponent(lawyer.chatUsername)}`;
                  const keyboard = {
                    inline_keyboard: [
                      [{
                        text: "–ù–∞—á–∞—Ç—å —á–∞—Ç",
                        url: chatUrl
                      }],
                      [{
                        text: "–ù–∞–∑–∞–¥ –∫ —é—Ä–∏—Å—Ç–∞–º",
                        callback_data: "command_lawyer"
                      }],
                      [{
                        text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                        callback_data: "main_menu"
                      }]
                    ]
                  };
                  if (lawyer.image) {
                    bot.sendPhoto(chatId, fs.createReadStream(lawyer.image), {
                      caption: clientMessage,
                      parse_mode: 'HTML',
                      reply_markup: keyboard
                    });
                  } else {
                    bot.sendMessage(chatId, clientMessage, {
                      parse_mode: 'HTML',
                      reply_markup: keyboard
                    });
                  }
                } else {
                  bot.sendMessage(chatId, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
              }
            } else {
              const keyboard = {
                inline_keyboard: [
                  [{
                    text: "–ù–∞–∑–∞–¥ –∫ —é—Ä–∏—Å—Ç–∞–º",
                    callback_data: "command_lawyer"
                  }],
                  [{
                    text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                    callback_data: "main_menu"
                  }]
                ]
              };
              if (lawyer.image) {
                bot.sendPhoto(chatId, fs.createReadStream(lawyer.image), {
                  caption: clientMessage,
                  parse_mode: 'HTML',
                  reply_markup: keyboard
                });
              } else {
                bot.sendMessage(chatId, clientMessage, {
                  parse_mode: 'HTML',
                  reply_markup: keyboard
                });
              }
            }
          }
        }

        if (otherLawyers && otherLawyers.length > 0) {
          const otherLawyersList = otherLawyers.map(lawyer => {
            const phones = lawyer.key.split(', ').map(num => `<a href="tel:${num.trim()}">${num.trim()}</a>`).join(', ');
            return `
              üîß ${lawyer.name}
              üìç –ê–¥—Ä–µ—Å: ${lawyer.address}
              üìû –¢–µ–ª–µ—Ñ–æ–Ω—ã: ${phones}
              ${lawyer.additional ? `\n${lawyer.additional}` : ''}
            `.replace(/^[ \t]+/gm, '').trim();
          }).join('\n\n');
          bot.sendMessage(chatId, `‚úÖ –ù–∞–π–¥–µ–Ω—ã —é—Ä–∏—Å—Ç—ã –¥–ª—è ${originalLawyerKey}:\n\n${otherLawyersList}`, {
            parse_mode: 'HTML',
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ù–∞–∑–∞–¥ –∫ —é—Ä–∏—Å—Ç–∞–º",
                  callback_data: "command_lawyer"
                }],
                [{
                  text: "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                  callback_data: "main_menu"
                }]
              ]
            }
          });
        } else if (!paidLawyers || (paidLawyers.length === 0 && !otherLawyers)) {
          bot.sendMessage(chatId, `üòû –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è "${originalLawyerKey}"`, {
            reply_markup: {
              inline_keyboard: [
                [{
                  text: "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                  callback_data: "command_lawyer"
                }]
              ]
            }
          });
        }
        break;
      case 'sell':
        if (params[0] === 'command') {
          showSellType(bot, chatId);
        } else if (params[0] === 'type') {
          state[chatId].sellTCType = params[1];
          showHowSell(bot, chatId);
        } else if (params[0] === 'how') {
          state[chatId].sellHow = params[1];
          showSellerInfo(bot, chatId, query, state[chatId]);
        }
        break;
      case 'products':
        if (params[0] === 'command') {
          showProductsType(bot, chatId);
        } else if (params[0] === 'type') {
          state[chatId].productType = params[1];
          const products = findProductByType(state[chatId].productType);
          if (products && products.length > 0) {
            const productList = products.map(product => {
              return `üõû <b>${product.name}</b>\nüí∞ –¶–µ–Ω–∞: ${product.price || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\nüìû –¢–µ–ª: ${product.phone || ''}\nüí¨ ${product.description || ''}`;
            }).join('\n\n');
            bot.sendMessage(chatId, productList, {
              parse_mode: 'HTML'
            });
          } else {
            bot.sendMessage(chatId, 'üö´ –ü—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.');
          }
        }
        break;
      case 'main':
        sendMainMenu(bot, chatId);
        break;
      case 'help':
        bot.sendMessage(chatId, 'üìñ –ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É:\n\n–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ @Gae4kinChaT');
        break;
      default:
        // Default case to handle unrecognized callbacks
        break;
    }

    bot.answerCallbackQuery(query.id);
  });
}

module.exports = {
  registerCallbackHandler
};